# sekret v0.3 — Spec

> Process-isolated execution, single-key retrieval, and Windows support.

---

## 1. Overview

v0.3 adds two new commands and expands platform support:

| Feature | Purpose |
|---------|---------|
| `sekret run -- <command>` | Execute a command with sekret keys injected as env vars |
| `sekret get <ENV_VAR>` | Retrieve a single key value to stdout |
| Windows support | Build, release, and CI for Windows |

---

## 2. `sekret run -- <command>`

Execute a child process with all registered keys injected as environment variables.
The keys exist only in the child process and do not persist in the current shell.

### Usage

```
$ sekret run -- python main.py
$ sekret run -- curl -H "Authorization: Bearer $OPENAI_API_KEY" https://api.openai.com/v1/models
$ sekret run -- env | grep API_KEY
```

### Behavior

1. Load all registered keys from the config and keychain (same logic as `sekret env`).
2. Build the child process environment: current `os.Environ()` + sekret keys overlaid.
3. Execute the command via `exec.Command`, inheriting stdin/stdout/stderr.
4. Exit with the child process's exit code.

### Options

| Flag | Description |
|------|-------------|
| `--` (required) | Separates sekret flags from the child command and its arguments |

### Edge Cases

| Case | Behavior |
|------|----------|
| No command given (`sekret run --`) | Error: `no command specified` |
| No keys registered | Execute the command anyway (with current env only), print warning to stderr |
| Key read failure | Print warning to stderr (same as `sekret env`), skip that key, continue |
| Child process exits non-zero | Exit with the same code |
| Command not found | Exit with code 127 (standard shell convention) |

### Exit Codes

| Code | Meaning |
|------|---------|
| `N` | Child process exit code (passed through) |
| `1` | sekret error (config load failure, etc.) |
| `127` | Command not found |

### Why `run` over `eval`

| | `eval "$(sekret env)"` | `sekret run -- cmd` |
|-|------------------------|---------------------|
| Keys visible in | Current shell + all children | Child process only |
| Shell history risk | Low (eval is safe) | None |
| Works in CI/Docker | Requires shell | Works anywhere |
| `.zshrc` integration | One-liner | N/A (per-command use) |

Both approaches are complementary. `eval` is for interactive shells; `run` is for scripts and CI.

---

## 3. `sekret get <ENV_VAR>`

Retrieve a single key value and print it to stdout with no trailing newline decoration.
Designed for piping and command substitution.

### Usage

```
$ sekret get OPENAI_API_KEY
sk-proj-abc123...

$ curl -H "Authorization: Bearer $(sekret get OPENAI_API_KEY)" https://api.openai.com/v1/models

$ sekret get GITHUB_TOKEN | pbcopy
```

### Behavior

1. Resolve the argument (env var name or shorthand, same as `sekret set`).
2. Look up the key in config, then read the value from keychain.
3. Print the raw value to stdout, followed by a single newline.

### Options

None. The command takes exactly one argument.

### Edge Cases

| Case | Behavior |
|------|----------|
| Key not registered | Error: `key "X" is not registered` |
| Keychain read failure | Error: `failed to read key "X": <reason>` |
| Shorthand name (e.g. `openai`) | Resolves to `OPENAI_API_KEY` (same as `sekret set`) |

### Security Consideration

The raw key value is printed to stdout. This is intentional for scripting use.
Users should avoid logging the output or redirecting it to a file.
Sekret will NOT add warnings to stdout (that would break piping).

---

## 4. Windows Support

### Goal

Produce Windows binaries and ensure CI passes on Windows.

### Changes

#### 4.1 GoReleaser

Add `windows` to the `goos` list:

```yaml
goos:
  - darwin
  - linux
  - windows
```

The archive format for Windows should be `zip` instead of `tar.gz`:

```yaml
archives:
  - format_overrides:
      - goos: windows
        format: zip
```

#### 4.2 CI

Add `windows-latest` to the test and build matrix in `.github/workflows/ci.yml`.

#### 4.3 Keychain

No code changes required. `go-keyring` uses Windows Credential Manager
via the `danieljoos/wincred` indirect dependency, which is already in `go.mod`.

#### 4.4 Terminal Input

`golang.org/x/term` already supports Windows. No changes needed.

#### 4.5 Known Limitations

- `eval "$(sekret env)"` is bash/zsh specific. On Windows, users should use
  `sekret run -- <command>` or PowerShell equivalent (`sekret env` output
  is not PowerShell-compatible in v0.3).
- PowerShell-native `sekret env` output format (e.g. `$env:KEY="val"`) is
  deferred to a future version.

---

## 5. Scope

### v0.3 — Included

- `sekret run -- <command>` — Process-isolated execution
- `sekret get <ENV_VAR>` — Single key retrieval
- Windows build, release, and CI

### Deferred

- `sekret doctor` — Key health check (v0.4+, after user feedback)
- `sekret scan --level` — Configurable detection (#25, after false positive reports)
- Linux headless fallback — Encrypted file or `pass` integration (v0.4)
- MCP server mode — Security model design needed (v0.4+)
- PowerShell-native `sekret env` output — Future Windows enhancement
