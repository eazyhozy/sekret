# sekret v0.2 — Spec

> Security tooling and user onboarding: detect plaintext keys and automate migration.

---

## 1. Overview

v0.2 adds two commands focused on helping users find and migrate plaintext API keys:

| Command | Purpose |
|---------|---------|
| `sekret scan` | Detect plaintext API keys in local files |
| `sekret import` | Auto-migrate `export` statements into sekret |

---

## 2. `sekret scan`

Scan local files for plaintext API keys and report their locations.

### Usage

```
$ sekret scan
$ sekret scan --path ~/.env
$ sekret scan --path ./config/
```

### Default Scan Targets

Shell config files in the home directory:

- `~/.zshrc`, `~/.zshenv`, `~/.zprofile`
- `~/.bashrc`, `~/.bash_profile`
- `~/.profile`

### Options

| Flag | Description |
|------|-------------|
| `--path <file or dir>` | Scan a specific file or directory instead of defaults |

### Detection Method

Scan `export` statements and flag them if the variable name matches either criterion:

**A. Built-in registry match** — The env var name matches a known entry:

| Env Variable | Name |
|-------------|------|
| `OPENAI_API_KEY` | openai |
| `ANTHROPIC_API_KEY` | anthropic |
| `GEMINI_API_KEY` | gemini |
| `GITHUB_TOKEN` | github |
| `GROQ_API_KEY` | groq |

**B. Suffix pattern match** — The env var name ends with:

- `_KEY`
- `_TOKEN`
- `_SECRET`
- `_CREDENTIALS`

Note: Key value prefixes (e.g. `sk-`, `sk-ant-`) are not used for detection.
Provider identification is based solely on the env var name, which is unambiguous and easier to maintain.

### Output

```
$ sekret scan

Found 3 potential plaintext keys:

  ~/.zshrc:12     export OPENAI_API_KEY="sk-proj-..."  (already in sekret, safe to remove)
  ~/.zshrc:25     export GITHUB_TOKEN="ghp_..."        (already in sekret, value differs!)
  ~/.zshrc:168    export KAP_API_KEY="kap_V0dQ..."

Run 'sekret import' to migrate these keys to the OS keychain.
```

- Values are masked in output (prefix + last 4 characters)
- Shows file path + line number
- Results are sorted by file path, then by line number
- Keys already registered in sekret are annotated:
  - `safe to remove` — value matches the keychain entry
  - `value differs!` — value does not match; user should verify which is correct

### Exit Codes

| Code | Meaning |
|------|---------|
| `0` | No plaintext keys found |
| `1` | Plaintext keys detected |

---

## 3. `sekret import`

Parse `export` statements from shell config files and register them in sekret.

### Usage

```
$ sekret import
$ sekret import --file ~/.zshrc
```

### Default Target Files

Same as `sekret scan` defaults.

### Options

| Flag | Description |
|------|-------------|
| `--file <path>` | Import from a specific file |

### Parsing Targets

Three `export` statement formats are supported:

```bash
export KEY="VALUE"
export KEY='VALUE'
export KEY=VALUE
```

### Interactive Flow

Each key is presented individually. The user can import, skip, or quit:

- `y` — Import this key (default, press Enter to accept)
- `s` — Skip this key
- `q` — Quit and stop processing remaining keys

```
$ sekret import

Scanning ~/.zshrc...

Found 3 exportable keys:

Import each key? (y: import / s: skip / q: quit)

  [1/3] OPENAI_API_KEY
        Import? [Y/s/q]: y
        Imported OPENAI_API_KEY

  [2/3] KAP_API_KEY
        Import? [Y/s/q]: y
        Imported KAP_API_KEY

  [3/3] SLACK_WEBHOOK_SECRET
        Import? [Y/s/q]: s
        Skipped

Done. 2 imported, 1 skipped.

  Imported:
    ~/.zshrc:12     OPENAI_API_KEY
    ~/.zshrc:168    KAP_API_KEY

  Skipped:
    ~/.zshrc:200    SLACK_WEBHOOK_SECRET

Remove the imported keys from your shell config (lines listed above).
```

If any key fails to import (e.g. keychain save error), a `Failed` section is shown:

```
Done. 1 imported, 1 skipped, 1 failed.

  Imported:
    ~/.zshrc:12     OPENAI_API_KEY

  Skipped:
    ~/.zshrc:200    SLACK_WEBHOOK_SECRET

  Failed:
    ~/.zshrc:168    KAP_API_KEY — failed to save to keychain

Remove the imported keys from your shell config (lines listed above).
```

Sections with zero items are omitted from the summary.

### Constraints

- **Never modifies the source file.** Shows file path + line number and instructs the user to remove manually.
- **Duplicate env var handling** depends on the implementation of #12. If an env var is already registered in sekret, inform the user and let them choose to skip or overwrite.

---

## 4. Scope

### v0.2 — Included

- `sekret scan` — Plaintext key detection
- `sekret import` — Auto-migration from `export` statements

### Deferred to v0.3

- `sekret run -- <command>` — Process-isolated execution
- `sekret doctor` — Diagnose required keys per AI tool
- Windows support
- Linux headless fallback
- MCP server mode
